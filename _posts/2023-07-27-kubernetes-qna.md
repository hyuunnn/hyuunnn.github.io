---
layout: post
title: "쿠버네티스 질문 정리"
description: ""
date: 2023-07-27
tags: []
---

<a href="https://www.yes24.com/Product/Goods/102099414">컨테이너 인프라 환경 구축을 위한 쿠버네티스/도커</a> 책 정독을 강력 추천한다. 개인적으로 헷갈렸던 부분들이 질문과 답변 형식으로 정리되어 있었다.

<a href="https://www.yes24.com/Product/Goods/92426926">핵심만 콕! 쿠버네티스</a> 책은 마스터 노드 1개, 워커 노드 1개로 실습하는데, 위 책은 마스터 노드 1개, 워커 노드 3개로 실습한다. 

특히 첫 번째 책을 읽으면서 파드가 여러 개의 워커 노드에 적절하게 배치된다는 것을 눈으로 확인할 수 있었다. 

사실 워커 노드가 하나라면 쿠버네티스를 사용하는 의미가 없다. (워커 노드를 여러개 만들어서 분산시키는게 핵심이기 때문)

* 파드가 반영속적, 불안정하다(ephemeral)는 의미가 무엇인가? 
    * 파드를 생성하기 전에 바라는 상태와 현재 상태를 확인한 후 다르다면 생성하는 구조이다. (선감시 후생성)
        * 파드가 죽지 않고 계속 살아있어야 함을 보장하지 않는다.
        * 파드가 죽었을 때 계속 살리는 것을 보장한다.
        * 파드를 강제로 삭제하더라도 컨트롤러에 정의한 상태를 유지하기 위해 파드를 다시 생성한다.
        * ```
          에어컨을 사용할 때 현재 상태(현재 온도)가 존재하고, 사용자가 바라는 상태(희망 온도)가 있습니다.
          에어컨 시스템이 현재 상태를 바라는 상태와 동일해지도록 제어하듯이 쿠버네티스도 자동으로 현재 상태를 바라는 상태로 변경합니다.
          바라는 상태를 가지는 것의 장점으로는 쿠버네티스에 장애가 발생하여 애플리케이션이 죽더라도 바라는 상태를 알기 때문에 손쉽게 원래의 바라는 상태로 배포 상태를 되살릴 수 있습니다. (자가 치유)
          핵심만 콕! 쿠버네티스 - p41
          ```
    * HPA(Horizontal Pod Autoscaler)
        * 설정한 사용률보다 올라가면 파드를 늘리고, 내려가면 파드가 줄어든다. 즉 파드가 규모에 따라서 삭제되거나 추가된다.
        * ```
          사용자가 갑자기 늘어난다면 어떻게 될까요?
          파드는 더 이상 감당할 수 없어서 서비스 불가라는 결과를 초래할 수도 있습니다.
          쿠버네티스는 이런 경우를 대비해 부하량에 따라 디플로이먼트의 파드 수를 유동적으로 관리하는 기능을 제공합니다.
          이를 HPA(Horizontal Pod Autoscaler)라고 합니다.
          컨테이너 인프라 환경 구축을 위한 쿠버네티스/도커 - p170
          ```
        * ```
          VPA(Vertical Pod Autoscaler)의 경우, 스케일 업을 수행하기 위해 파드를 제거하고 다시 배포하는 과정이 수행되면서 큰 오버헤드가 발생하기 때문에 일반적으로는 HPA가 많이 사용된다.
          오토스케일링 알고리즘 비교를 위한 요청 수 기반 쿠버네티스 Horizontal Pod Autoscaler 모델링 - 장용현 외 4명
          ```
            * VPA는 파드의 리소스가 부족한 경우, 파드를 스케일 업한다. (<a href="https://kimjingo.tistory.com/166">설명</a>)

* 파드는 생성될 때마다 새로운 내부 IP를 할당 받는다는데?
    * ```
      쿠버네티스에 배포된 오브젝트들은 IP가 변경돼도 CoreDNS를 통해
      도메인 이름(라벨링)으로 통신하여 서로 연결할 수 있습니다.
      컨테이너 인프라 환경 구축을 위한 쿠버네티스/도커 - p480
      ```

* 왜 파드가 여러개 존재하는가?
    * 대규모 서비스는 사용량이 많아지는 만큼 부하를 분산시켜야 한다. (규모가 작으면 굳이 그럴 필요가 없다.)
    * 이는 쿠버네티스가 대규모 서비스에 적합함을 의미하기도 한다.
    * 대규모 서비스의 경우 서비스가 죽어서 잠깐이라도 서비스가 안된다면 이는 엄청난 손실이기 때문에 자동으로 재배포하는 과정이 중요하다. (무중단 배포)
        * 잠깐 멈추는 것 자체가 문제 (<a href="https://tv.kakao.com/channel/3693125/cliplink/423597081">가동률 99.999%</a>를 목표로 하는 카카오페이)
    * 스케줄러에 의해 선택된 파드에서 사용하는 컨테이너들은 물리적으로 다른 컨테이너가 맞다.
        * 그래서 최대한 동일한 환경의 컨테이너로 구성해야 한다. (업데이트할 때 모든 파드를 업데이트하지 않고 점진적으로 진행하는 등 - 롤링 업데이트)
        * 컨테이너로 공통된 부분을 잘 묶어서 만들어야 한다. (개발자의 몫)

* 노드포트 서비스를 사용하여 포트를 열었을 때 마스터 노드와 워커 노드 IP에서 접속할 수 있는 이유
    * ```
      노드포트 서비스를 설정하면 모든 워커 노드의 특정 포트를 열고 들어오는 모든 요청을 노드포트 서비스로 전달합니다.
      그리고 노드포트 서비스는 해당 업무를 처리할 수 있는 파드로 요청을 전달합니다.
      컨테이너 인프라 환경 구축을 위한 쿠버네티스/도커 - p147
      ```
    * 애초에 기능이 노드로 구분되는 것이 아니다. 
        ![0](/assets/images/kubernetes-qna/0.png)
        파드에 할당된 워커 노드를 보면 `w1-k8s`, `w2-k8s`, `w3-k8s` 등 효율적으로 배치되어 있다.
        하나의 디플로이먼트 컨트롤러에 의해 5개의 파드가 생성되었고, 이는 각각의 워커 노드에 적절히 배치되었다.
        로드밸런서도 설정한 IP에 접속하면 컨트롤러에 의해 적절한 파드로 요청이 전달된다.
    * 하나의 포트에 하나의 서비스가 연결되어 있는 구조이며, 여러 노드 중 하나의 IP와 특정 포트만 알면 접근할 수 있다.
        * 노드 IP와 unknown 포트를 노출해야 한다는 단점이 있다.
        * 또한 노드를 생성할 때마다 IP가 다르다는 특징도 있다.
        * 이를 해결하기 위해 로드밸런서를 사용한다. 
        * ![1](/assets/images/kubernetes-qna/1.png)
        * ![2](/assets/images/kubernetes-qna/2.png)
          이미 할당된 포트를 사용하면 오류가 발생한다. (kubectl 명령어로 삭제해야 함)

* 노드가 죽으면 해당 노드 안의 파드는 어떻게 되는가?
    * `w2-k8s` 종료 전 - `in-ip-pod` 5개, `np-pods` 9개 존재
        * ![3](/assets/images/kubernetes-qna/3.png)
    * `w2-k8s` 종로 후 - `in-ip-pod` 2개, `np-pods` 3개 Terminating 상태이며, `w1-k8s`, `w3-k8s` 노드에 새로운 파드 생성
        * ![4](/assets/images/kubernetes-qna/4.png)
    * `w2-k8s` 다시 시작
        * Terminating 상태였던 파드들의 READY 값이 0/1로 바뀌었다.
        * 노드에 접근하여 사용 중인 파드가 있는지 조회한 것으로 보인다.
    * `최종 결과` - `w2-k8s`에서 사용하는 파드는 없기 때문에 목록에서 사라짐
        * ![5](/assets/images/kubernetes-qna/5.png)
    * 현재 상태에서 `in-ip-pod`의 수를 5개에서 9개로 늘렸을 때 - 모두 `w2-k8s`에 배치된다.
        * ![6](/assets/images/kubernetes-qna/6.png)

## 참고

* <a href="https://www.yes24.com/Product/Goods/92426926">핵심만 콕! 쿠버네티스</a>
* <a href="https://www.yes24.com/Product/Goods/102099414">컨테이너 인프라 환경 구축을 위한 쿠버네티스/도커</a>
* <a href="https://seongjin.me/kubernetes-core-concepts/">쿠버네티스와 컨테이너 오케스트레이션, 그리고 핵심 설계 사상</a>
* <a href="https://seongjin.me/kubernetes-pods/">파드(Pod)의 개념과 생명 주기, 그리고 상태 진단을 위한 프로브(Probe) 활용</a>
* <a href="https://seongjin.me/kubernetes-service-types/">쿠버네티스에서 반드시 알아야 할 서비스(Service) 유형</a>
* <a href="https://saramin.github.io/2022-05-17-kubernetes-autoscaling/">Kubernetes에서 HPA를 활용한 오토스케일링</a>
* <a href="https://youtu.be/V-Ib-DdconY">K8S HPA 강의 제대로 듣고 있었습니까? 정신 차리십시오</a>
* <a href="https://youtu.be/76e2KOcmNSY">Kubernetes에서 확장 가능한 운영 HPA - 김상혁</a>
* <a href="https://tech.kakao.com/2018/12/24/kubernetes-deploy/">kubernetes를 이용한 서비스 무중단 배포</a>
